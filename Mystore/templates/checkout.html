<!DOCTYPE html>
<html>
<head>
    <title>Payment Form</title>
    <!-- Include your CSS stylesheets here -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="content-section">
        <form id="paymentForm" method="POST" action="">
            {{ form.hidden_tag() }}
            <fieldset class="form-group">
                <legend class="border-bottom mb-4">Make Payment</legend>
                <div class="form-group">
                    <label class="form-control-label" for="email">Email</label>
                    {{ form.email(class="form-control form-control-lg") }}
                    {% if form.email.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.email.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
                <div class="form-group">
                    <label class="form-control-label" for="amount">Amount to Pay (in NGN)</label>
                    {{ form.amount(class="form-control form-control-lg") }}
                    {% if form.amount.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.amount.errors %}
                                <span>{{ error }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </fieldset>
            <div class="form-group">
                <button type="submit" class="btn btn-outline-info">Pay Now</button>
            </div>
        </form>
    </div>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <script>
        var paymentForm = document.getElementById('paymentForm');
        paymentForm.addEventListener('submit', payWithPaystack, false);
        function payWithPaystack() {
          var handler = PaystackPop.setup({
            key: 'pk_live_8017ced3f46c94721ee3446267b26043297018ff', // Replace with your actual public key from Paystack
            email: document.getElementById('email-address').value,
            amount: document.getElementById('amount').value * 100,
            currency: 'NGN',
            ref: 'UNIQUE_REFERENCE', // Replace with a reference you generate for each payment
            callback: function(response) {
              var reference = response.reference;
              alert('Payment complete! Reference: ' + reference);
              window.location.href = '/success?file_identifier=' + reference;
              // Make an AJAX call to your server with the reference to verify the transaction
              fetch('/verify-payment', {
                method: 'POST', // or 'GET' if your server expects GET requests
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ reference: reference })
              })
              .then(response => response.json())
              .then(data => {
                // Handle the response from your server
                console.log(data);
              })
              .catch(error => {
                // Handle any errors
                console.error('Error:', error);
              });
            },
            onClose: function() {
              alert('Transaction was not completed, window closed.');
            },
          });
          handler.openIframe();
        }
    </script>
</body>
</html>
